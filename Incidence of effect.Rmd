---
title: "Incidence of effect"
author: "Dr. Weihsueh Chiu, En-Hsuan Lu"
date: "2023-01-19"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(grid)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE)
```

## data folder

```{r datafolder}
datafolder <- "BBMD plot"
female_mice <- fread(file.path(datafolder,"don-female-parameters.csv"))
male_mice <- fread(file.path(datafolder,"don-male-parameters.csv"))
```

## read files

```{r read}
HDMI.df <- fread("HDMI.samples.csv")
BE.urine.df <- fread("Urine BE.samples.csv")
BE.blood.df <- fread("Blood BE.samples.csv")
#human exposure dose levels
d_H <- c(0,10^seq(-4,1,0.1))
be_H <- c(0,10^seq(-4,1,0.1))
b_be_H <- c(0,10^seq(-4,1,0.1))
```

##set seed

```{r setseed}
set.seed(1234)
```

##incidence of effect by DON dose
```{r loop}
# incidence of BMR=5%
# This is dose (back in original units) where median person has effect = BMR
HDM50 <- (HDMI.df$bmd/1000) / (HDMI.df$AF_interTK*HDMI.df$AF_interTD)
incBMR <- numeric() # incidence of BMR
for (j in 1:length(d_H)) {
  # This is the fraction of population affected at dose d_H[j]
  incBMR <- cbind(incBMR,plnorm(d_H[j],meanlog = log(HDM50), sdlog = log(HDMI.df$Intra_var.GSD)))
}
incBMR <- as.data.frame(incBMR)
names(incBMR) <- paste("dose",1:length(d_H),sep=".")
incBMRconf <- as.data.frame(t(apply(incBMR,2,quantile,prob=c(0.05,0.5,0.95))))
incBMRconf$d_H <- d_H

incBMR5 <- ggplot(incBMRconf)+
  geom_ribbon(aes(x=d_H,ymin =`5%`,ymax=`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=`50%`))+
  geom_line(aes(x=d_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("DON dose (mg/kg-day)")+ylab("Population incidence of 5% decrease in body Weight")+
  theme_bw()+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(0,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(incBMR5)

incBMR5.log <- ggplot(incBMRconf)+
  geom_ribbon(aes(x=d_H,ymin =`5%`,ymax=`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=`50%`))+
  geom_line(aes(x=d_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("DON dose (mg/kg-day)")+ylab("Population incidence of 5% decrease in body weight")+
  theme_bw()+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(3e-3,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x, n=3),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  geom_point(aes(x=0.00137, y=1e-2), color="red", size=3, shape=15)+
  geom_point(aes(x=1.118482e-03, y=6.6e-03), color="darkgreen", size=3, shape=9)+
  geom_segment(aes(x=2.110046e-04,y=6.6e-03/2,xend=2.110046e-04,yend=6.6e-03*2),color="darkgreen",linetype="solid")+
  geom_rect(aes(xmin=3.949904e-05, xmax=1.118482e-03,ymin=6.6e-03/2,ymax=6.6e-03*2), fill="darkgreen", alpha= 0.005)+ #ymax=y*2; ymin=y/2
  geom_point(aes(x=1.410770e-02, y=3.9e-01), color="steelblue", size=3, shape=9)+
  geom_segment(aes(x=1.143537e-03,y=3.9e-01/2,xend=1.143537e-03,yend=3.9e-01*2),color="steelblue",linetype="solid")+
  geom_rect(aes(xmin=8.762731e-05, xmax=1.410770e-02,ymin=3.9e-01/2, ymax=3.9e-01*2), fill="steelblue", alpha= 0.005)+
  annotation_logticks(sides="bl")+
  theme(axis.title = element_text(size = 11), text = element_text(size = 11),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())
print(incBMR5.log)
```

# dose-response (fractional change) at different population percentiles

```{r set function}
#set function 
frachange.1 <- function(a,b,dose, dose.max = 1.5){
  resp <- (a*exp(b*dose/dose.max))/(a*exp(b*0))-1
  return(resp)
}
frachange.2 <- function(a,b,g,dose, dose.max = 1.5){
  resp <- (a*exp(b*((dose/dose.max)^g)))/(a*exp(b*(0^g)))-1
  return(resp)
}
frachange.3 <- function(a,b,c,dose, dose.max = 1.5){
  resp <- (a*(c-(c-1)*exp(-b*dose/dose.max)))/(a*(c-(c-1)*exp(-b*0)))-1
  return(resp)
}
frachange.4 <- function(a,b,c,g,dose, dose.max = 1.5){
  resp <- (a*(c-(c-1)*exp(-(b*dose/dose.max)^g)))/(a*(c-(c-1)*exp(-(b*0)^g)))-1
  return(resp)
}
frachange.5 <- function(a,b,c,g,dose, dose.max = 1.5){
  resp <- (a+(b*(dose/dose.max)^g)/(c^g+(dose/dose.max)^g))/(a+(b*0^g)/(c^g+0^g))-1
  return(resp)
}
frachange.6 <- function(a,b,g,dose, dose.max = 1.5){
  resp <- (a+b*((dose/dose.max)^g))/(a+b*(0^g))-1
  return(resp)
}
frachange.7 <- function(a,b,c,dose, dose.max = 1.5){
  resp <- (a+(b*dose/dose.max)/(c+dose/dose.max))/(a+(b*0)/(c+0))-1
  return(resp)
}
frachange.8 <- function(a,b,dose, dose.max = 1.5){
  resp <- (a+b*dose/dose.max)/(a+b*0)-1
  return(resp)
}
```

#Individual percentiles
```{r loop}
yconf.df <- data.frame()
for (inc in c(0.01,0.05,0.5,0.95,0.99)) { # individual percentiles
  z_i <- qnorm(1-inc) # percentile
  y<-numeric() # blank 
  for (j in 1:length(d_H)) {
    AED <- d_H[j] * HDMI.df$AF_interTK * HDMI.df$AF_interTD * (HDMI.df$Intra_var.GSD^z_i)
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]], dose.max=1.5)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]], dose.max=1.5)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]], dose.max=1.5)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]], dose.max=1.5)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]], dose.max=1.5)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]], dose.max=1.5)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]], dose.max=1.5)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]], dose.max=1.5)
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]], dose.max=1.1)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]], dose.max=1.1)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]], dose.max=1.1)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]], dose.max=1.1)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]], dose.max=1.1)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]], dose.max=1.1)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]], dose.max=1.1)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]], dose.max=1.1)
    )
    y <- cbind(y,c(y_female,y_male))
  }
  y <- as.data.frame(y)
  names(y) <- paste("dose",1:length(d_H),sep=".")
  yconf <- as.data.frame(t(apply(y,2,quantile,prob=c(0.05,0.5,0.95))))
  yconf$d_H <- d_H
  yconf$inc <- inc
  yconf.df <- rbind(yconf.df,yconf)
}
yconf.df$poppct <- factor(paste0(100*yconf.df$inc,"%ile"))

percent01 <- ggplot(subset(yconf.df, poppct %in% "1%ile"))+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("1%ile of Population") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent01)

percent05 <- ggplot(subset(yconf.df, poppct %in% "5%ile"))+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("5%ile of Population") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent05)

percent50 <- ggplot(subset(yconf.df, poppct %in% "50%ile"))+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("50%ile of Population") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent50)

percent95 <- ggplot(subset(yconf.df, poppct %in% "95%ile"))+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("95%ile of Population") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent95)

percent99 <- ggplot(subset(yconf.df, poppct %in% "99%ile"))+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("99%ile of Population") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent99)

### Population mean
yconfmean.df <- data.frame()
ymean<-numeric() # blank 
npop <- 100
zrand <- rnorm(npop) # npop random individuals
for (j in 1:length(d_H)) {
  y<-numeric() # blank 
  for (k in 1:npop) {
    z_i <- zrand[k]
    AED <- d_H[j] * HDMI.df$AF_interTK * HDMI.df$AF_interTD * (HDMI.df$Intra_var.GSD^z_i)
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]])
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]])
    )
    y <- cbind(y,c(y_female,y_male))
  }
  ymean <- cbind(ymean,apply(y,1,mean))
}
ymean<-as.data.frame(ymean)
names(ymean) <- paste("dose",1:length(d_H),sep=".")
yconfmean <- as.data.frame(t(apply(ymean,2,quantile,prob=c(0.05,0.5,0.95))))
yconfmean$d_H <- d_H

popmean <- ggplot(yconfmean)+
  geom_ribbon(aes(x=d_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=d_H,y=100*`50%`))+
  geom_line(aes(x=d_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=d_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("Population Mean") + 
  xlab("DON dose (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00137, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(popmean)

doseresp.BMR5 <- ggarrange(incBMR5, incBMR5.log, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 18))
doseresp.pop <- ggarrange(popmean, percent01, percent50, percent99, labels = c("C","D","E","F"), nrow = 4, ncol = 1, font.label = list(size = 18))
doseresp <- ggarrange(doseresp.BMR5, doseresp.pop, nrow=1, ncol=2)
ggsave("HDMI fraction of response.pdf",plot=doseresp, scale=0.7, width=20, height=20)

hdmi_fracresp <- ggarrange(popmean, percent01, percent05, percent50, nrow=4, ncol=1)
```

### incidence of effect by urine BE

```{r loop}
# incidence of BMR=5%
# This is BE (back in original units) where median person has effect = BMR
BE50 <- ((BE.urine.df$bmd/1000)*BE.urine.df$Cavg_dose_a*BE.urine.df$U_Cavg_h.GM) /BE.urine.df$AF_interTD
incBMR <- numeric() # incidence of BMR
for (j in 1:length(be_H)) {
  # This is the fraction of population affected at dose be_H[j]
  incBMR <- cbind(incBMR,plnorm(be_H[j],meanlog = log(BE50), sdlog = log(BE.urine.df$Intra.GSD)))
}
incBMR <- as.data.frame(incBMR)
names(incBMR) <- paste("urineBE",1:length(be_H),sep=".")
incBMRconf <- as.data.frame(t(apply(incBMR,2,quantile,prob=c(0.05,0.5,0.95))))
incBMRconf$be_H <- be_H

incBMR5.be <- ggplot(incBMRconf)+
  geom_ribbon(aes(x=be_H,ymin =`5%`,ymax=`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=`50%`))+
  geom_line(aes(x=be_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Population incidence of 5% decrease in body weight")+
  theme_bw()+
  coord_cartesian(xlim=c(5e-5,1),ylim=c(0,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  geom_vline(xintercept=2.508499e-05, linetype="dotted", color="darkgreen")+
  geom_vline(xintercept=7.170922e-04, linetype="dotted", color="darkgreen")+
  geom_vline(xintercept=1.346428e-04, linetype="solid", color="darkgreen")+
  geom_rect(aes(xmin=2.508499e-05, xmax=7.170922e-04,ymin=1e-7,ymax=Inf), fill="darkgreen", alpha= 0.005)+
  geom_vline(xintercept=0.0001367598, linetype="dotted", color="steelblue")+
  geom_vline(xintercept=0.0053842140, linetype="dotted", color="steelblue")+
  geom_vline(xintercept=0.0008617678, linetype="solid", color="steelblue")+
  geom_rect(aes(xmin=0.0001367598, xmax=0.0053842140,ymin=1e-7,ymax=Inf), fill="steelblue", alpha= 0.005)+
  annotation_logticks(sides="b")
print(incBMR5.be)

incBMR5.be.log <- ggplot(incBMRconf)+
  geom_ribbon(aes(x=be_H,ymin =`5%`,ymax=`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=`50%`))+
  geom_line(aes(x=be_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Population incidence of 5% decrease in body weight")+
  theme_bw()+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(3e-3,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x, n=3),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  geom_point(aes(x=0.001, y=1e-2), color="red", size=3, shape=15)+
  geom_point(aes(x=7.170922e-04, y=5e-03), color="darkgreen", size=3, shape=9)+
  geom_segment(aes(x=1.346428e-04,y=5e-03/2,xend=1.346428e-04,yend=5e-03*2),color="darkgreen",linetype="solid")+
  geom_rect(aes(xmin=2.508499e-05, xmax=7.170922e-04,ymin=5e-03/2,ymax=5e-03*2), fill="darkgreen", alpha= 0.005)+ #ymax=y*2; ymin=y/2
  geom_point(aes(x=0.0053842140, y=0.21), color="steelblue", size=3, shape=9)+
  geom_segment(aes(x=0.0008617678,y=0.21/2,xend=0.0008617678,yend=0.21*2),color="steelblue",linetype="solid")+
  geom_rect(aes(xmin=0.0001367598, xmax=0.0053842140,ymin=0.21/2, ymax=0.21*2), fill="steelblue", alpha= 0.005)+
  annotation_logticks(sides="bl")+
  theme(axis.title = element_text(size = 11), text = element_text(size = 11),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())
print(incBMR5.be.log)
```

#### dose-response (fractional change) at different population percentiles

```{r loop}
##Individual percentiles
yconf.df <- data.frame()
for (inc in c(0.01,0.05,0.5,0.95,0.99)) { # individual percentiles
  z_i <- qnorm(1-inc) # percentile
  y<-numeric() # blank 
  for (j in 1:length(be_H)) {
    AED <- (be_H[j] * BE.urine.df$AF_interTD * (BE.urine.df$Intra.GSD^z_i))/(BE.urine.df$Cavg_dose_a*BE.urine.df$U_Cavg_h.GM)
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]], dose.max=1.5)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]], dose.max=1.5)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]], dose.max=1.5)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]], dose.max=1.5)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]], dose.max=1.5)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]], dose.max=1.5)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]], dose.max=1.5)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]], dose.max=1.5)
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]], dose.max=1.1)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]], dose.max=1.1)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]], dose.max=1.1)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]], dose.max=1.1)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]], dose.max=1.1)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]], dose.max=1.1)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]], dose.max=1.1)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]], dose.max=1.1)
    )
    y <- cbind(y,c(y_female,y_male))
  }
  y <- as.data.frame(y)
  names(y) <- paste("BE",1:length(be_H),sep=".")
  yconf <- as.data.frame(t(apply(y,2,quantile,prob=c(0.05,0.5,0.95))))
  yconf$be_H <- be_H
  yconf$inc <- inc
  yconf.df <- rbind(yconf.df,yconf)
}
yconf.df$poppct <- factor(paste0(100*yconf.df$inc,"%ile"))

percent01.be <- ggplot(subset(yconf.df, poppct %in% "1%ile"))+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("1%ile of Population") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent01.be)

percent05.be <- ggplot(subset(yconf.df, poppct %in% "5%ile"))+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("5%ile of Population") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent05.be)

percent50.be <- ggplot(subset(yconf.df, poppct %in% "50%ile"))+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("50%ile of Population") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent50.be)

percent95.be <- ggplot(subset(yconf.df, poppct %in% "95%ile"))+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("95%ile of Population") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent95.be)

percent99.be <- ggplot(subset(yconf.df, poppct %in% "99%ile"))+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("99%ile of Population") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent99.be)

### Population mean

yconfmean.df <- data.frame()
ymean<-numeric() # blank 
npop <- 100
zrand <- rnorm(npop) # npop random individuals
for (j in 1:length(be_H)) {
  y<-numeric() # blank 
  for (k in 1:npop) {
    z_i <- zrand[k]
    AED <- (be_H[j] * BE.urine.df$AF_interTD * (BE.urine.df$Intra.GSD^z_i))/(BE.urine.df$Cavg_dose_a*BE.urine.df$U_Cavg_h.GM)
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]])
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]])
    )
    y <- cbind(y,c(y_female,y_male))
  }
  ymean <- cbind(ymean,apply(y,1,mean))
}
ymean<-as.data.frame(ymean)
names(ymean) <- paste("BE",1:length(be_H),sep=".")
yconfmean <- as.data.frame(t(apply(ymean,2,quantile,prob=c(0.05,0.5,0.95))))
yconfmean$be_H <- be_H

popmean.be <- ggplot(yconfmean)+
  geom_ribbon(aes(x=be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("Population Mean") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(popmean.be)

### Population random sample 

#yconfran.df <- data.frame()
yran<-numeric() # blank 
npop <- 100
zrand <- rnorm(npop) # npop random individuals
for (j in 1:length(be_H)) {
  y<-numeric() # blank 
  for (k in 1:npop) {
    z_i <- zrand[k]
    AED <- (be_H[j] * BE.urine.df$AF_interTD * (BE.urine.df$Intra.GSD^z_i))/(BE.urine.df$Cavg_dose_a*BE.urine.df$U_Cavg_h.GM)
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]])
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]])
    )
    y <- cbind(y_female,y_male)
    #y <- cbind(y,c(y_female,y_male))
  }
  yran <- cbind(yran,apply(y, 1, sample, size=1))
}
yran<-as.data.frame(yran)
names(yran) <- paste("BE",1:length(be_H),sep=".")
yconfran <- as.data.frame(t(apply(yran,2,quantile,prob=c(0.05,0.5,0.95))))
yconfran$be_H <- be_H

popran.be <- ggplot(yconfran)+
  geom_ribbon(aes(x=be_H,ymin=100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=be_H,y=100*`50%`))+
  geom_line(aes(x=be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("Population Random Sample") + 
  xlab("Urinary biomonitoring equivalent (mg/kg-day)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-3,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.001, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(popran.be)

##combine graphs
urine_fracresp.BMR5 <- ggarrange(incBMR5.be, incBMR5.be.log, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 18))
urine_fracresp.pop <- ggarrange(popmean.be, percent01.be, percent50.be, percent99.be, labels = c("C","D","E","F"), nrow = 4, ncol = 1, font.label = list(size = 18))
urine_fracresp <- ggarrange(urine_fracresp.BMR5, urine_fracresp.pop, nrow=1, ncol=2)
ggsave("Urinary BE fraction of response.pdf",plot=urine_fracresp, scale=0.7, width=20, height=20)

be.u_fracresp <- ggarrange(popmean.be, percent01.be, percent05.be, percent50.be, nrow = 4, ncol = 1)
```

##incidence of effect by blood BE

```{r loop}
# incidence of BMR=5%
# This is BE (back in original units) where median person has effect = BMR
b_BE50 <- ((BE.blood.df$bmd/1000)*BE.blood.df$Cavg_dose_a) /BE.blood.df$AF_interTD
b_incBMR <- numeric() # incidence of BMR
for (j in 1:length(b_be_H)) {
  # This is the fraction of population affected at dose be_H[j]
  b_incBMR <- cbind(b_incBMR,plnorm(b_be_H[j],meanlog = log(b_BE50), sdlog = log(BE.blood.df$TD_var.GSD)))
}
b_incBMR <- as.data.frame(b_incBMR)
names(b_incBMR) <- paste("bloodBE",1:length(b_be_H),sep=".")
b_incBMRconf <- as.data.frame(t(apply(b_incBMR,2,quantile,prob=c(0.05,0.5,0.95))))
b_incBMRconf$b_be_H <- b_be_H

incBMR5.b_be <- ggplot(b_incBMRconf)+
  geom_ribbon(aes(x=b_be_H,ymin =`5%`,ymax=`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=`50%`))+
  geom_line(aes(x=b_be_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Population incidence of 5% decrease in body weight")+
  theme_bw()+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(0,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(incBMR5.b_be)

incBMR5.b_be.log <- ggplot(b_incBMRconf)+
  geom_ribbon(aes(x=b_be_H,ymin =`5%`,ymax=`95%`),alpha=0.3)+
  geom_line(aes(x=b_be_H,y=`50%`))+
  geom_line(aes(x=b_be_H,y=`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=`95%`),linetype="dotted",alpha=0.5)+
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Population incidence of 5% decrease in body weight")+
  theme_bw()+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(3e-3,1))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x, n=3),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(axis.title = element_text(size = 11), text = element_text(size = 11),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  geom_point(aes(x=0.00017, y=1e-2), color="red", size=3, shape=15)+
  annotation_logticks(sides="bl")
print(incBMR5.b_be.log)
```

#### dose-response (fractional change) at different population percentiles

```{r loop}
##Individual percentiles
yconf.df <- data.frame()
for (inc in c(0.01,0.05,0.5,0.95,0.99)) { # individual percentiles
  z_i <- qnorm(1-inc) # percentile
  y<-numeric() # blank 
  for (j in 1:length(b_be_H)) {
    AED <- (b_be_H[j] * BE.blood.df$AF_interTD * (BE.blood.df$TD_var.GSD^z_i))/BE.blood.df$Cavg_dose_a
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]], dose.max=1.5)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]], dose.max=1.5)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]], dose.max=1.5)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]], dose.max=1.5)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]], dose.max=1.5)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]], dose.max=1.5)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]], dose.max=1.5)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]], dose.max=1.5)
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]], dose.max=1.1)
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]], dose.max=1.1)
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]], dose.max=1.1)
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]], dose.max=1.1)
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]], dose.max=1.1)
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]], dose.max=1.1)
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]], dose.max=1.1)
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]], dose.max=1.1)
    )
    y <- cbind(y,c(y_female,y_male))
  }
  y <- as.data.frame(y)
  names(y) <- paste("b_BE",1:length(b_be_H),sep=".")
  yconf <- as.data.frame(t(apply(y,2,quantile,prob=c(0.05,0.5,0.95))))
  yconf$b_be_H <- b_be_H
  yconf$inc <- inc
  yconf.df <- rbind(yconf.df,yconf)
}
yconf.df$poppct <- factor(paste0(100*yconf.df$inc,"%ile"))

percent01.b_be <- ggplot(subset(yconf.df, poppct %in% "1%ile"))+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("1%ile of Population") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent01.b_be)

percent05.b_be <- ggplot(subset(yconf.df, poppct %in% "5%ile"))+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("5%ile of Population") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent05.b_be)

percent50.b_be <- ggplot(subset(yconf.df, poppct %in% "50%ile"))+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("50%ile of Population") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent50.b_be)

percent95.b_be <- ggplot(subset(yconf.df, poppct %in% "95%ile"))+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("95%ile of Population") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent95.b_be)

percent99.b_be <- ggplot(subset(yconf.df, poppct %in% "99%ile"))+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("99%ile of Population") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(percent99.b_be)

### Population mean

yconfmean.df <- data.frame()
ymean<-numeric() # blank 
npop <- 100
zrand <- rnorm(npop) # npop random individuals
for (j in 1:length(b_be_H)) {
  y<-numeric() # blank 
  for (k in 1:npop) {
    z_i <- zrand[k]
    AED <- (b_be_H[j] * BE.blood.df$AF_interTD * (BE.blood.df$TD_var.GSD^z_i))/BE.blood.df$Cavg_dose_a
    
    #model weight
    w_k_female <- c(0.271, 0.077, 0.216, 0.052, 0.058, 0.031, 0.174, 0.12)
    w_k_female <- w_k_female/sum(w_k_female) # Make sure adds up to 1
    w_k_female_cum <- cumsum(w_k_female) # Cumulative
    w_k_male <- c(0.224, 0.12, 0.09, 0.064, 0.065, 0.11, 0.058, 0.27)
    w_k_male <- w_k_male/sum(w_k_male) # Make sure adds up to 1
    w_k_male_cum <- cumsum(w_k_male) # Cumulative
    
    w_k5000_female_cum <- c(0,round(5000*w_k_female_cum)) # start/end index numbers
    w_k5000_male_cum <- 5000+c(0,round(5000*w_k_male_cum)) # start/end index numbers
    
    w_k5000_female <- diff(w_k5000_female_cum) # Difference is size
    w_k5000_male <- diff(w_k5000_male_cum) # Difference is size
    
    samp.parms.1 <- female_mice[sample(c(1:15000), size=w_k5000_female[1]),]
    samp.parms.2 <- female_mice[sample(c(15001:30000), size=w_k5000_female[2]),]
    samp.parms.3 <- female_mice[sample(c(30001:45000), size=w_k5000_female[3]),]
    samp.parms.4 <- female_mice[sample(c(45001:60000), size=w_k5000_female[4]),]
    samp.parms.5 <- female_mice[sample(c(60001:75000), size=w_k5000_female[5]),]
    samp.parms.6 <- female_mice[sample(c(75001:90000), size=w_k5000_female[6]),]
    samp.parms.7 <- female_mice[sample(c(90001:105000), size=w_k5000_female[7]),]
    samp.parms.8 <- female_mice[sample(c(105001:120000), size=w_k5000_female[8]),]

    # Use subsamples of AED
    y_female <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_female_cum[1]):w_k5000_female_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_female_cum[2]):w_k5000_female_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_female_cum[3]):w_k5000_female_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_female_cum[4]):w_k5000_female_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_female_cum[5]):w_k5000_female_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_female_cum[6]):w_k5000_female_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_female_cum[7]):w_k5000_female_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_female_cum[8]):w_k5000_female_cum[9]])
    )
    
    samp.parms.1 <- male_mice[sample(c(1:15000), size=w_k5000_male[1]),]
    samp.parms.2 <- male_mice[sample(c(15001:30000), size=w_k5000_male[2]),]
    samp.parms.3 <- male_mice[sample(c(30001:45000), size=w_k5000_male[3]),]
    samp.parms.4 <- male_mice[sample(c(45001:60000), size=w_k5000_male[4]),]
    samp.parms.5 <- male_mice[sample(c(60001:75000), size=w_k5000_male[5]),]
    samp.parms.6 <- male_mice[sample(c(75001:90000), size=w_k5000_male[6]),]
    samp.parms.7 <- male_mice[sample(c(90001:105000), size=w_k5000_male[7]),]
    samp.parms.8 <- male_mice[sample(c(105001:120000), size=w_k5000_male[8]),]
    
    y_male <- c(
      frachange.1(a=samp.parms.1$a, b=samp.parms.1$b, dose=AED[(1+w_k5000_male_cum[1]):w_k5000_male_cum[2]])
      ,frachange.2(a=samp.parms.2$a, b=samp.parms.2$b, g=samp.parms.2$g, dose=AED[(1+w_k5000_male_cum[2]):w_k5000_male_cum[3]])
      ,frachange.3(a=samp.parms.3$a, b=samp.parms.3$b, c=samp.parms.3$c, dose=AED[(1+w_k5000_male_cum[3]):w_k5000_male_cum[4]])
      ,frachange.4(a=samp.parms.4$a, b=samp.parms.4$b, c=samp.parms.4$c, g=samp.parms.4$g, dose=AED[(1+w_k5000_male_cum[4]):w_k5000_male_cum[5]])
      ,frachange.5(a=samp.parms.5$a, b=samp.parms.5$b, c=samp.parms.5$c, g=samp.parms.5$g, dose=AED[(1+w_k5000_male_cum[5]):w_k5000_male_cum[6]])
      ,frachange.6(a=samp.parms.6$a, b=samp.parms.6$b, g=samp.parms.6$g, dose=AED[(1+w_k5000_male_cum[6]):w_k5000_male_cum[7]])
      ,frachange.7(a=samp.parms.7$a, b=samp.parms.7$b, c=samp.parms.7$c, dose=AED[(1+w_k5000_male_cum[7]):w_k5000_male_cum[8]])
      ,frachange.8(a=samp.parms.8$a, b=samp.parms.8$b, dose=AED[(1+w_k5000_male_cum[8]):w_k5000_male_cum[9]])
    )
    y <- cbind(y,c(y_female,y_male))
  }
  ymean <- cbind(ymean,apply(y,1,mean))
}
ymean<-as.data.frame(ymean)
names(ymean) <- paste("b_BE",1:length(b_be_H),sep=".")
yconfmean <- as.data.frame(t(apply(ymean,2,quantile,prob=c(0.05,0.5,0.95))))
yconfmean$b_be_H <- b_be_H

popmean.b_be <- ggplot(yconfmean)+
  geom_ribbon(aes(x=b_be_H,ymin =100*`5%`,ymax=100*`95%`),alpha=0.2)+
  geom_line(aes(x=b_be_H,y=100*`50%`))+
  geom_line(aes(x=b_be_H,y=100*`5%`),linetype="dotted",alpha=0.5)+
  geom_line(aes(x=b_be_H,y=100*`95%`),linetype="dotted",alpha=0.5)+
  theme_bw()+
  ggtitle("Population Mean") + 
  xlab("Blood biomonitoring equivalent (mg/L)")+ylab("Percent change in body weight (%)")+
  coord_cartesian(xlim=c(1e-4,1),ylim=c(-25,0))+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_vline(xintercept=0.00017, linetype="dashed", color="red")+
  annotation_logticks(sides="b")
print(popmean.b_be)

##combine graphs
blood_fracresp.BMR5 <- ggarrange(incBMR5.b_be, incBMR5.b_be.log, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 18))
blood_fracresp.pop <- ggarrange(popmean.b_be, percent01.b_be, percent50.b_be, percent99.b_be, labels = c("C","D","E","F"), nrow = 4, ncol = 1, font.label = list(size = 18))
blood_fracresp <- ggarrange(blood_fracresp.BMR5, blood_fracresp.pop, nrow=1, ncol=2)
ggsave("Blood BE fraction of response.pdf", plot=blood_fracresp, scale=0.7, width=20, height=20)

be.b_fracresp <- ggarrange(popmean.b_be, percent01.b_be, percent05.b_be, percent50.b_be, nrow = 4, ncol = 1)
```

###Log scale: Population Incidence of 5% Decrease in Body Weight

```{r ggplot}
popincidence <- ggarrange(incBMR5.log, incBMR5.b_be.log, incBMR5.be.log, 
                          nrow=3, ncol=1, labels = c("A","B","C"), font.label = list(size = 14))
ggsave("Log scale Population Incidence of 5 percent Decrease in Body Weight.pdf", plot=popincidence, scale=0.7, width=8, height=20)
```

## % Change in body weight for different fraction of population

```{r ggplot}
frac.pop <- ggarrange(hdmi_fracresp, be.b_fracresp, be.u_fracresp, nrow = 1, ncol = 3, labels = c("A","B","C"), font.label = list(size = 18))
ggsave("Percent change in BW for fractions of population.pdf", plot=frac.pop, scale=0.7, width=24, height=22)
```

#Martins et al. (2019) exposure
use PDI * 0.64

```{r random}
set.seed(1234)
don.urine <- fread(file.path("InputData","don exposure.csv"))
don.urine$exp <- don.urine$`PDI DON`*0.64
urine.q <- quantile(don.urine$exp, prob=c(0.5,0.95))
#Median: 0.134 ug/kg-d = 0.000134 mg/kg-d
#P95: 1.014 ug/kg-d = 0.001014 mg/kg-d
#P95/P50=7.567
#GM: 0.000134; GSD: 7.567^(1/1.96)=2.808216
mar_exp <- rlnorm(10000, meanlog = log(0.000134), sdlog=log(2.808216))
quantile(mar_exp, prob=c(0.5, 0.05, 0.95))
```

#Wang et al. 2019
use published quantile values

```{r random}
set.seed(1234)
#24 urine volume: 1.5 L
#BW=(18.03*65+35.08*61+53.93*64+66.48*260+62.47*149)/(65+61+64+260+149)
#  =55.686 kg
# (Vol/day urine)* Conc urine = mg/d
# (mg/d)/kg bw = mg/kg-d
#Q1=14.84 ng/ml = (14.84 ng/ml * 1500 ml/d)/55.686 kg = 399.7414 ng/kg-d = 0.0003997414 mg/kg-d
#Q3=68.25 mg/ml = (68.25 ng/ml * 1500 ml/d)/55.686 kg = 1838.433 ng/kg-d = 0.001838433 mg/kg-d
#GM: (0.0003997414*0.001838433)^(1/2) = 0.0008572618
#GSD: (0.001838433/0.0003997414)^(1/(qnorm(0.75)-qnorm(0.25))) = 3.09911

wang_exp <- rlnorm(10000, meanlog = log(0.0008572618), sdlog = log(3.09911))
quantile(wang_exp, prob=c(0.5, 0.05, 0.95))

d_wang.urine <- ecdf(wang_exp)
100*(1-d_wang.urine(0.00183))
```
